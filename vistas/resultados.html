<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados</title>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/ui.css">
  <style>
    .result-card { max-width:640px; margin:3rem auto; padding:1.5rem; border-radius:12px; box-shadow:var(--sombra-media); background:var(--color-blanco); text-align:center }
    .scores-grid {
      display: grid;
      gap: 1.2rem;
      justify-content: center;
      margin: 2.2rem 0 1.2rem 0;
    }
    .score-box {
      
      min-height: 120px;
      padding: 1.2rem 1rem;
      flex-direction: column;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    
    .actions { display:flex; gap:0.8rem; justify-content:center; margin-top:1.2rem }
    @media (max-width: 600px) {
      .score-box { min-width: 140px; max-width: 100%; }
    }
  </style>
</head>
<body class="body--juegos">
  <main>
    <section class="result-card">

      <h1>Misión completada</h1>
      <p id="summary">Esto fue lo que lograste</p>

      <div id="score-section" class="scores-grid">
        <div class="score-box">
          <strong>Aciertos</strong>
          <div id="aciertos-score" style="font-size:2.2rem; font-weight:700; margin:0.5rem 0;">0</div>
        </div>
        <div class="score-box" id="attempts-row-box" style="display:none;">
          <strong>Intentos</strong>
          <div id="attempts-row" style="font-size:2.2rem; font-weight:700; margin:0.5rem 0;"></div>
        </div>
        <div class="score-box">
          <strong>Puntos en este nivel</strong>
          <div id="game-score" style="font-size:2.2rem; font-weight:700; margin:0.5rem 0;">0</div>
        </div>
        <div class="score-box bg-acumulado">
          <strong>Puntos acumulados</strong>
          <div id="total-game-score" style="font-size:2.2rem; font-weight:700; margin:0.5rem 0;">0</div>
        </div>
      </div>

      <div class="actions" id="badges-action-row" style="display:none;">
        <button id="btn-badges" class="resultados-btn btn-warning">Recoger insignias</button>
      </div>

      <div class="actions" style="margin-top:0.5rem;">
        <button id="btn-repeat" class="resultados-btn">Repetir nivel</button>
        <button id="btn-next" class="resultados-btn siguiente">Siguiente nivel</button>
        <button id="btn-menu" class="resultados-btn menu">Volver al menú</button>
      </div>

    </section>
  </main>

  <script type="module">
        // Ajustar la cuadrícula de las cards según cuántas estén visibles
        function ajustarGridCards() {
          const grid = document.getElementById('score-section');
          const cards = Array.from(grid.querySelectorAll('.score-box'));
          // Solo contar las cards visibles
          const visibles = cards.filter(card => card.style.display !== 'none');
          if (visibles.length === 3) {
            grid.style.gridTemplateColumns = '1fr';
            grid.style.gridTemplateRows = 'repeat(3, 1fr)';
          } else if (visibles.length === 4) {
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gridTemplateRows = '1fr 1fr';
          } else {
            grid.style.gridTemplateColumns = '';
            grid.style.gridTemplateRows = '';
          }
        }

        // Llamar al ajustarGridCards después de mostrar/ocultar cards
        setTimeout(ajustarGridCards, 0);
    import { getTotalScore, getGameScore, getLevelPoints, hasCompletedLevel, getBadge } from '../js/util.js';
      import { getSessionScore } from '../js/util.js';
    let BADGES_DICT = {};
    async function loadBadgesDict() {
      try {
        const resp = await fetch('../js/data/badges.json');
        BADGES_DICT = await resp.json();
      } catch (e) { BADGES_DICT = {}; }
    }

    const params = new URLSearchParams(location.search);
    const game = params.get('game');
    const level = params.get('level');
    console.log('Resultados para juego: nivel:|'+level+"|");

    const aciertosScoreEl = document.getElementById('aciertos-score');
    const gameScoreEl = document.getElementById('game-score');
    const summary = document.getElementById('summary');
    const attemptsRow = document.getElementById('attempts-row');
    const attemptsRowBox = document.getElementById('attempts-row-box');
    const totalGameScoreEl = document.getElementById('total-game-score');

    const btnRepeat = document.getElementById('btn-repeat');
    const btnNext = document.getElementById('btn-next');
    const btnMenu = document.getElementById('btn-menu');
    const badgeModal = document.createElement('div');
    badgeModal.id = 'badge-modal';
    badgeModal.style.position = 'fixed';
    badgeModal.style.left = '0';
    badgeModal.style.top = '0';
    badgeModal.style.right = '0';
    badgeModal.style.bottom = '0';
    badgeModal.style.display = 'flex';
    badgeModal.style.alignItems = 'center';
    badgeModal.style.justifyContent = 'center';
    badgeModal.style.background = 'rgba(0,0,0,0.45)';
    badgeModal.style.zIndex = '5000';
    badgeModal.style.visibility = 'hidden';
    badgeModal.innerHTML = `
      <div style="background:white;padding:20px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.25)">
        <h2 id="badge-title">¡Insignia ganada!</h2>
        <p id="badge-desc"></p>
        <div style="margin-top:12px;"><button id="badge-close" class="btn btn-primary">Cerrar</button></div>
      </div>`;
    document.body.appendChild(badgeModal);

    const badgeTitle = document.getElementById('badge-title');
    const badgeDesc = document.getElementById('badge-desc');

    const levelOrder = ['nivel-facil','nivel-intermedio','nivel-dificil'];

    function resolveGamePath(gameId, lvl) {
      // Map known games to their level page structure
      if (!gameId) return '../index.html';
      if (gameId === 'juego1') {
        if (lvl === 'nivel-facil') return `./juego1/juego1nivel1.html?level=nivel-facil`;
        if (lvl === 'nivel-intermedio') return `./juego1/juego1nivel2.html?level=nivel-intermedio`;
        if (lvl === 'nivel-dificil') return `./juego1/juego1nivel3.html?level=nivel-dificil`;
        return `./juego1/juego1nivel1.html?level=nivel-facil`;
      }
      if (gameId === 'juego2') {
        if (lvl === 'nivel-facil') return `./juego2/juego2nivel1.html?level=nivel-facil`;
        if (lvl === 'nivel-intermedio') return `./juego2/juego2nivel2.html?level=nivel-intermedio`;
        if (lvl === 'nivel-dificil') return `./juego2/juego2nivel3.html?level=nivel-dificil`;
        return `./juego2/juego2nivel1.html?level=nivel-facil`;
      };
      if (gameId === 'juego3') {
        if (lvl === 'nivel-facil') return `./juego3/juego3nivel1.html?level=nivel-facil`;
        if (lvl === 'nivel-intermedio') return `./juego3/juego3nivel2.html?level=nivel-intermedio`;
        if (lvl === 'nivel-dificil') return `./juego3/juego3nivel3.html?level=nivel-dificil`;
        return `./juego3/juego3nivel1.html?level=nivel-facil`;
      };
      return '../index.html';
    }

    // populate scores and progress bar
    const total = getTotalScore();
    //const progressFill = document.getElementById('progress-fill');
    //const progressPercent = document.getElementById('progress-percent');
    const totalScoreText = document.getElementById('total-game-score');

    // assume 3 games * 60 points (10+20+30) as maximum
    const MAX_GAMES = 3;
    const maxPoints = MAX_GAMES * (10 + 20 + 30); // 180
    const pct = Math.min(100, Math.round((total / maxPoints) * 100));
    //progressFill.style.width = pct + '%';
    //  progressPercent.textContent = pct + '%';
    totalScoreText.textContent = total + ' pts';

    // si hay insignia en query, mostrar modal
    // Mostrar todas las insignias ganadas (pueden venir varios parámetros 'badge')
    const badgeParams = [];
    for (const [key, value] of params.entries()) {
      if (key === 'badge') badgeParams.push(value);
    }
    // Cargar el diccionario de insignias y luego mostrar el botón/modal si corresponde
    await loadBadgesDict();
    const badgesActionRow = document.getElementById('badges-action-row');
    const btnBadges = document.getElementById('btn-badges');
    if (badgeParams.length) {
      badgesActionRow.style.display = 'flex';
      // Ocultar los otros botones si hay insignias
      btnRepeat.style.display = 'none';
      btnNext.style.display = 'none';
      btnMenu.style.display = 'none';
      btnBadges.addEventListener('click', () => {
        // Redirigir a la pantalla de insignias, agregando game y level
        let url = '../vistas/insignias.html';
        if (game) url += (url.includes('?') ? '&' : '?') + 'game=' + encodeURIComponent(game);
        if (level) url += (url.includes('?') ? '&' : '?') + 'level=' + encodeURIComponent(level);
        badgeParams.forEach(badgeId => {
          url += (url.includes('?') ? '&' : '?') + 'badge=' + encodeURIComponent(badgeId);
        });
        window.location.href = url;
      });
    } else {
      badgesActionRow.style.display = 'none';
      btnRepeat.style.display = '';
      btnNext.style.display = '';
      btnMenu.style.display = '';
    }




    // Puntos obtenidos en esta sesión para este juego
    let gScore = 0;
    if (game) {
      gScore = getSessionScore(game);
      // Si no hay puntaje de sesión, usar el acumulado como fallback
      if (!gScore) gScore = getGameScore(game);
    }
    gameScoreEl.textContent = gScore;

    // Aciertos: para juego1 nivel-facil, buscar en localStorage; para otros juegos, puedes adaptar la lógica

    // Leer aciertos e intentos de la URL si existen
    let aciertos = 0;
    let intentos = 0;
    // Mostrar aciertos para todos los niveles
    try {
      aciertos = parseInt(params.get('aciertos') || '0', 10);
    } catch (e) {}
    if (aciertosScoreEl) aciertosScoreEl.textContent = aciertos;
    // Mostrar intentos para todos los juegos
    try {
      intentos = parseInt(params.get('intentos') || '0', 10);
    } catch (e) {}
    attemptsRowBox.style.display = 'flex';
    attemptsRow.textContent = `${intentos}`;
    ajustarGridCards();

    // Puntos acumulados en todo el juego
    // Mostrar el total acumulado de todos los juegos
    let totalGameScore = 0;
    try {
      totalGameScore = getTotalScore();
    } catch (e) {}
    if (totalGameScoreEl) totalGameScoreEl.textContent = totalGameScore;

    // Mostrar intentos solo para juego1 nivel-facil
    if (game === 'juego1' && (level === 'nivel-facil' || level === 'nivel-intermedio')) {
      console.log('Mostrando intentos para juego1 nivel-facil');
      console.log(game +" nivel "+ level);
      // Buscar intentos en localStorage o similar (ajusta según tu lógica)
      
      attemptsRow.style.display = 'block';
      attemptsRow.textContent = `${intentos}`;
      ajustarGridCards();
    } else {
      attemptsRow.style.display = 'none';
      attemptsRowBox.style.display = 'none';
      ajustarGridCards();
    }


    // Botón recoger insignias
    //const btnBadges = document.getElementById('btn-badges');
    //if (btnBadges) btnBadges.addEventListener('click', () => {
      // Mostrar modal de insignias si hay, o redirigir a sección de insignias
    //  badgeModal.style.visibility = 'visible';
    //});

    btnMenu.addEventListener('click', () => { location.href = '../index.html'; });

    btnRepeat.addEventListener('click', () => {
      const path = resolveGamePath(game, level || 'nivel-facil');
      location.href = path;
    });

    console.log('boton next:', btnNext);
    btnNext.addEventListener('click', () => {
      if (!level) return;
      const idx = levelOrder.indexOf(level);
      const next = idx >= 0 && idx < levelOrder.length - 1 ? levelOrder[idx+1] : null;
      if (!next || level === 'nivel-dificil') {
        // no next level — hide the button
        try { btnNext.style.display = 'none'; } catch (e) {}
        return;
      }
      const path = resolveGamePath(game, next);
      location.href = path;
    });

    // hide next if already at last level
    if (!level || level === 'nivel-dificil') {
      try { btnNext.style.display = 'none'; } catch (e) {}
    }

  </script>
</body>
</html>
