<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Resultados</title>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/ui.css">
  <style>
    .result-card { max-width:640px; margin:3rem auto; padding:1.5rem; border-radius:12px; box-shadow:var(--sombra-media); background:var(--color-blanco); text-align:center }
    .scores { display:flex; gap:1rem; justify-content:center; margin:1rem 0 }
    .score-box { padding:0.8rem 1rem; border-radius:10px; background:#f4f6fb }
    .actions { display:flex; gap:0.8rem; justify-content:center; margin-top:1.2rem }
  </style>
</head>
<body class="body--juegos">
  <main>
    <section class="result-card">
      <h1>Resultados</h1>
      <p id="summary">Cargando...</p>

      <!-- Barra de progreso centrada arriba -->
      <div id="progress-center" style="text-align:center; margin:12px 0 18px 0;">
        <div style="max-width:560px; margin:0 auto;">
          <div id="progress-bar" style="height:18px; background:#eef3ff; border-radius:10px; overflow:hidden; position:relative;">
            <div id="progress-fill" style="height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#6c8cff); transition:width 500ms ease;"></div>
          </div>
          <div style="margin-top:8px; font-size:0.95rem; color:var(--color-primario);"> <span id="progress-percent">0%</span> — <small id="total-score-text">0 pts</small></div>
        </div>
      </div>

      <div class="scores">
        <div class="score-box">
          <strong>Puntos en este juego</strong>
          <div id="game-score">0</div>
        </div>

        <div class="score-box">
          <strong>Puntos del nivel</strong>
          <div id="level-points">0</div>
        </div>
      </div>

      <div class="actions">
        <button id="btn-repeat" class="btn btn-primary">Repetir nivel</button>
        <button id="btn-next" class="btn btn-success">Siguiente nivel</button>
        <button id="btn-menu" class="btn btn-secondary">Volver al menú</button>
      </div>

    </section>
  </main>

  <script type="module">
    import { getTotalScore, getGameScore, getLevelPoints, hasCompletedLevel, getBadge } from '../js/util.js';

    const params = new URLSearchParams(location.search);
    const game = params.get('game');
    const level = params.get('level');

    const totalScoreEl = document.getElementById('total-score');
    const gameScoreEl = document.getElementById('game-score');
    const levelPointsEl = document.getElementById('level-points');
    const summary = document.getElementById('summary');

    const btnRepeat = document.getElementById('btn-repeat');
    const btnNext = document.getElementById('btn-next');
    const btnMenu = document.getElementById('btn-menu');
    const badgeModal = document.createElement('div');
    badgeModal.id = 'badge-modal';
    badgeModal.style.position = 'fixed';
    badgeModal.style.left = '0';
    badgeModal.style.top = '0';
    badgeModal.style.right = '0';
    badgeModal.style.bottom = '0';
    badgeModal.style.display = 'flex';
    badgeModal.style.alignItems = 'center';
    badgeModal.style.justifyContent = 'center';
    badgeModal.style.background = 'rgba(0,0,0,0.45)';
    badgeModal.style.zIndex = '5000';
    badgeModal.style.visibility = 'hidden';
    badgeModal.innerHTML = `
      <div style="background:white;padding:20px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,0.25)">
        <h2 id="badge-title">¡Insignia ganada!</h2>
        <p id="badge-desc"></p>
        <div style="margin-top:12px;"><button id="badge-close" class="btn btn-primary">Cerrar</button></div>
      </div>`;
    document.body.appendChild(badgeModal);

    const badgeTitle = document.getElementById('badge-title');
    const badgeDesc = document.getElementById('badge-desc');

    const levelOrder = ['nivel-facil','nivel-intermedio','nivel-dificil'];

    function resolveGamePath(gameId, lvl) {
      // Map known games to their level page structure
      if (!gameId) return '../index.php';
      if (gameId === 'juego1') {
        if (lvl === 'nivel-facil') return `./juego1/juego1nivel1.html?level=nivel-facil`;
        if (lvl === 'nivel-intermedio') return `./juego1/juego1nivel2.html?level=nivel-intermedio`;
        if (lvl === 'nivel-dificil') return `./juego1/juego1nivel3.html?level=nivel-dificil`;
        return `./juego1/juego1nivel1.html?level=nivel-facil`;
      }
      if (gameId === 'juego2') return `./juego2/juego2nivel1.html?level=${encodeURIComponent(lvl)}`;
      if (gameId === 'juego3') return `./juego3/juego3nivel1.html?level=${encodeURIComponent(lvl)}`;
      return '../index.php';
    }

    // populate scores and progress bar
    const total = getTotalScore();
    const progressFill = document.getElementById('progress-fill');
    const progressPercent = document.getElementById('progress-percent');
    const totalScoreText = document.getElementById('total-score-text');

    // assume 3 games * 60 points (10+20+30) as maximum
    const MAX_GAMES = 3;
    const maxPoints = MAX_GAMES * (10 + 20 + 30); // 180
    const pct = Math.min(100, Math.round((total / maxPoints) * 100));
    progressFill.style.width = pct + '%';
    progressPercent.textContent = pct + '%';
    totalScoreText.textContent = total + ' pts';

    // si hay insignia en query, mostrar modal
    const badgeParam = params.get('badge');
    if (badgeParam && game) {
      const badge = getBadge(game, badgeParam);
      if (badge) {
        badgeTitle.textContent = badge.name || 'Insignia';
        badgeDesc.textContent = badge.desc || 'Has recibido una insignia';
        badgeModal.style.visibility = 'visible';
        const closeBtn = document.getElementById('badge-close');
        closeBtn.addEventListener('click', () => { badgeModal.style.visibility = 'hidden'; });
      }
    }

    const gScore = game ? getGameScore(game) : 0;
    gameScoreEl.textContent = gScore;

    const lvlPts = level ? getLevelPoints(level) : 0;
    levelPointsEl.textContent = lvlPts;

    if (game && level) {
      summary.textContent = `Has completado el nivel ${level.replace('nivel-','')} de ${game}.`;
    } else {
      summary.textContent = 'Progreso guardado.';
    }

    // buttons
    btnMenu.addEventListener('click', () => { location.href = '../index.php'; });

    btnRepeat.addEventListener('click', () => {
      const path = resolveGamePath(game, level || 'nivel-facil');
      location.href = path;
    });

    btnNext.addEventListener('click', () => {
      if (!level) return;
      const idx = levelOrder.indexOf(level);
      const next = idx >= 0 && idx < levelOrder.length - 1 ? levelOrder[idx+1] : null;
      if (!next || level === 'nivel-dificil') {
        // no next level — hide the button
        try { btnNext.style.display = 'none'; } catch (e) {}
        return;
      }
      const path = resolveGamePath(game, next);
      location.href = path;
    });

    // hide next if already at last level
    if (!level || level === 'nivel-dificil') {
      try { btnNext.style.display = 'none'; } catch (e) {}
    }

  </script>
</body>
</html>
